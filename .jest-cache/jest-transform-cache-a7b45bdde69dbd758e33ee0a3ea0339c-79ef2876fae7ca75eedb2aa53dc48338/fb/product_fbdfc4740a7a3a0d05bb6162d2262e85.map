{"version":3,"names":["cache","require","wpClient","getWcAuthHeader","getLdAuthHeader","config","CACHE_TTL","getProduct","id","cacheKey","redis","getClient","cached","get","JSON","parse","wcRes","headers","Authorization","product","data","relatedCourses","relatedCourseMeta","meta_data","find","m","key","value","matches","match","allInts","map","parseInt","filter","_","index","Array","isArray","courses","Promise","all","courseId","courseRes","title","rendered","link","err","response","status","error","console","message","name","slug","price","related_courses","set","stringify","Error","module","exports"],"sources":["product.js"],"sourcesContent":["const cache = require('./cache');\nconst { wpClient, getWcAuthHeader, getLdAuthHeader } = require('./http');\nconst config = require('../config');\n\nconst CACHE_TTL = 3600; // 1 hour\n\nconst getProduct = async (id) => {\n    const cacheKey = `sistemagigantes:bff:product:${id}`;\n    const redis = cache.getClient();\n\n    // Cache Aside\n    const cached = await redis.get(cacheKey);\n    if (cached) {\n        return JSON.parse(cached);\n    }\n\n    try {\n        // Fetch Product from WooCommerce\n        const wcRes = await wpClient.get(`/wc/v3/products/${id}`, {\n            headers: {\n                Authorization: getWcAuthHeader()\n            }\n        });\n        const product = wcRes.data;\n\n        // Extract Related Courses (using metadata)\n        // According to report: meta_key: '_related_course'\n        // meta_value: \"a:4:{i:0;i:2553;i:1;i:2327;i:2;i:2324;i:3;i:1836;}\" (PHP Serialized)\n        // We might not be able to easily deserialize PHP in JS without a library.\n        // Alternative: If LearnDash/WC exposes this in a better way.\n        // Or we use a regex or a simple parser if it's just an array of IDs.\n\n        let relatedCourses = [];\n        const relatedCourseMeta = product.meta_data.find(m => m.key === '_related_course');\n\n        if (relatedCourseMeta && typeof relatedCourseMeta.value === 'string') {\n            // Simple regex to extract integers from the serialized string\n            // Matches i:<integer>; or s:<length>:\"<value>\"; (but here we expect IDs)\n            // Example: i:2553;\n            const matches = relatedCourseMeta.value.match(/i:(\\d+);/g);\n            if (matches) {\n                // PHP Serialized array: i:0;i:2553;i:1;i:2327;\n                // Matches will be: [\"i:0;\", \"i:2553;\", \"i:1;\", \"i:2327;\"]\n                // We want the values (odd indices), not the keys (even indices).\n                const allInts = matches.map(m => parseInt(m.match(/i:(\\d+);/)[1]));\n                relatedCourses = allInts.filter((_, index) => index % 2 !== 0);\n            }\n        } else if (relatedCourseMeta && Array.isArray(relatedCourseMeta.value)) {\n            // Sometimes API returns it deserialized (less likely for this plugin)\n            relatedCourses = relatedCourseMeta.value;\n        }\n\n        // Fetch Courses Details (Optimized: Parallel or Single call if supported)\n        // LD API: /ldlms/v2/sfwd-courses/<id>\n        // Use Promise.all\n        const courses = await Promise.all(relatedCourses.map(async (courseId) => {\n            try {\n                // Check cache for individual course first? \n                // Report says: sistemagigantes:bff:product:{id} caches everything.\n                // We'll just fetch.\n                const courseRes = await wpClient.get(`/ldlms/v2/sfwd-courses/${courseId}`, {\n                    headers: {\n                        Authorization: getLdAuthHeader()\n                    }\n                });\n                return {\n                    id: courseRes.data.id,\n                    title: courseRes.data.title && courseRes.data.title.rendered,\n                    link: courseRes.data.link\n                };\n            } catch (err) {\n                if (err.response && err.response.status === 404) {\n                    return { id: courseId, error: 'Course not found (404)' };\n                }\n                console.error(`Failed to fetch course ${courseId}:`, err.message);\n                return { id: courseId, error: err.message || 'Failed to load course data' };\n            }\n        }));\n\n        const response = {\n            id: product.id,\n            name: product.name,\n            slug: product.slug,\n            price: product.price,\n            status: product.status,\n            related_courses: courses\n        };\n\n        // Save to Redis\n        await redis.set(cacheKey, JSON.stringify(response), 'EX', CACHE_TTL);\n\n        return response;\n\n    } catch (error) {\n        if (error.response && error.response.status === 404) {\n            throw new Error('Product not found');\n        }\n        throw error;\n    }\n};\n\nmodule.exports = {\n    getProduct\n};\n"],"mappings":"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","ignoreList":[]}