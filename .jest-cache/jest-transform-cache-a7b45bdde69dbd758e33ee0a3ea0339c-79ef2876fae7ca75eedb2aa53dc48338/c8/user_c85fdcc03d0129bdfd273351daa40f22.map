{"version":3,"names":["cache","require","wpClient","getLdAuthHeader","CACHE_TTL","getUserDashboard","id","cacheKey","redis","getClient","cached","get","JSON","parse","userRes","headers","Authorization","user","data","dashboard","name","avatar_url","avatar_urls","courses","warnings","coursesRes","timeout","coursesData","Array","isArray","coursesWithProgress","Promise","all","map","course","progressRes","pData","progressPercent","course_progress","total_steps","completed_steps","title","rendered","progress","Math","round","err","error","console","message","push","set","stringify","response","status","Error","module","exports"],"sources":["user.js"],"sourcesContent":["const cache = require('./cache');\nconst { wpClient, getLdAuthHeader } = require('./http');\n\nconst CACHE_TTL = 300; // 5 minutes\n\nconst getUserDashboard = async (id) => {\n    const cacheKey = `sistemagigantes:bff:user:${id}:dashboard`;\n    const redis = cache.getClient();\n\n    const cached = await redis.get(cacheKey);\n    if (cached) {\n        return JSON.parse(cached);\n    }\n\n    try {\n        // Fetch Basic User Data\n        // WP API: /wp/v2/users/<id>\n        const userRes = await wpClient.get(`/wp/v2/users/${id}`, {\n            headers: {\n                Authorization: getLdAuthHeader() // Using LD admin creds to see user data\n            }\n        });\n        const user = userRes.data;\n\n        const dashboard = {\n            id: user.id,\n            name: user.name,\n            avatar_url: user.avatar_urls && user.avatar_urls['96'],\n            courses: [],\n            warnings: []\n        };\n\n        // Circuit Breaker for LearnDash\n        // Fetch Enrolled Courses\n        // LD API: /ldlms/v2/users-courses?user=<id>\n        try {\n            const coursesRes = await wpClient.get(`/ldlms/v2/users-courses?user=${id}`, {\n                timeout: 3000, // Strict timeout for circuit breaker simulation\n                headers: {\n                    Authorization: getLdAuthHeader()\n                }\n            });\n\n            // Map courses\n            // The endpoint returns list of course IDs or objects depending on query\n            // Usually returns generic post objects.\n\n            // Note: The LD API might respond with \"headers\" or specific structure.\n            // Assuming array of objects.\n            const coursesData = Array.isArray(coursesRes.data) ? coursesRes.data : [];\n\n            // Get Progress for each course\n            // LD API: /ldlms/v2/users-course-progress_v2?user=<id>&course=<course_id>\n            // This is heavy. Let's limit concurrency or check if we can get all at once.\n            // Documentation implies one by one.\n\n            const coursesWithProgress = await Promise.all(coursesData.map(async (course) => {\n                try {\n                    const progressRes = await wpClient.get(`/ldlms/v2/users-course-progress_v2?user=${id}&course=${course.id}`, {\n                        timeout: 2000, // Short timeout\n                        headers: { Authorization: getLdAuthHeader() }\n                    });\n\n                    // Helper to calculate percentage.\n                    // Structure depends on LD version. Often has 'steps_completed', 'steps_total'.\n                    const pData = progressRes.data;\n                    let progressPercent = 0;\n                    // Heuristic for progress\n                    if (pData.course_progress && pData.course_progress.total_steps > 0) {\n                        progressPercent = (pData.course_progress.completed_steps / pData.course_progress.total_steps) * 100;\n                    }\n\n                    return {\n                        id: course.id,\n                        title: course.title && course.title.rendered,\n                        progress: Math.round(progressPercent)\n                    };\n                } catch (err) {\n                    return {\n                        id: course.id,\n                        title: course.title && course.title.rendered,\n                        progress: null,\n                        error: 'Progress unavailable'\n                    };\n                }\n            }));\n\n            dashboard.courses = coursesWithProgress;\n\n        } catch (error) {\n            console.error('LearnDash Circuit Breaker:', error.message);\n            dashboard.warnings.push('Cursos indispon√≠veis temporariamente');\n            // We still return user data\n        }\n\n        // Cache the result\n        await redis.set(cacheKey, JSON.stringify(dashboard), 'EX', CACHE_TTL);\n\n        return dashboard;\n    } catch (error) {\n        if (error.response && error.response.status === 404) {\n            throw new Error('User not found');\n        }\n        throw error;\n    }\n};\n\nmodule.exports = {\n    getUserDashboard\n};\n"],"mappings":"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","ignoreList":[]}