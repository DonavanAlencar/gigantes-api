{"version":3,"names":["axios","require","http","https","config","httpAgent","Agent","keepAlive","httpsAgent","wpClient","create","baseURL","wordpress","url","timeout","headers","process","env","USE_MOCKS","fs","path","console","log","defaults","adapter","Promise","resolve","reject","mockFile","regex","match","ns","pathSuffix","folderNs","rootMockDir","cwd","possibleDir","join","resource","id","existsSync","lstatSync","isDirectory","parts","split","length","pop","baseDir","specific","def","list","rootDefault","data","JSON","parse","readFileSync","status","statusText","request","e","message","response","name","code","getWcAuthHeader","auth","Buffer","from","wcConsumerKey","wcConsumerSecret","toString","getLdAuthHeader","ldUser","ldAppPassword","module","exports"],"sources":["http.js"],"sourcesContent":["const axios = require('axios');\nconst http = require('http');\nconst https = require('https');\nconst config = require('../config');\n\nconst httpAgent = new http.Agent({ keepAlive: true });\nconst httpsAgent = new https.Agent({ keepAlive: true });\n\nconst wpClient = axios.create({\n    baseURL: config.wordpress.url,\n    timeout: 15000, // 15 seconds default timeout\n    httpAgent,\n    httpsAgent,\n    headers: {\n        'Content-Type': 'application/json',\n    },\n});\n\n// Mock Adapter Implementation\nif (process.env.USE_MOCKS === 'true') {\n    const fs = require('fs');\n    const path = require('path');\n    console.log('⚠️  USING MOCKS FOR EXTERNAL HTTP CALLS ⚠️');\n\n    wpClient.defaults.adapter = async (config) => {\n        return new Promise((resolve, reject) => {\n            const url = config.url || '';\n            let mockFile = '';\n\n            // Generic Router\n            // Improved Regex to handle nested resources like 'products/categories' or 'reports/sales'.\n            // Strategy: Check specifically for known nested patterns first, or use a more greedy match.\n            // But 'products/123' vs 'products/categories' is ambiguous without knowledge.\n            // Let's hardcode known nested valid endpoints for this project as exceptions, or check directory existence.\n\n            // Simple approach: Capture up to 2 segments after version.\n            const regex = /^\\/?(?:(wc)\\/v3|(ldlms)\\/v2|(wp)\\/v2)\\/(.+)/;\n            const match = url.match(regex);\n\n            if (match) {\n                const ns = match[1] || match[2] || match[3]; // wc, ldlms, wp\n                const pathSuffix = match[4]; // e.g. \"products/categories\", \"products/123\", \"orders\"\n\n                // We need to decide what part is 'resource' and what is 'id'.\n                // Heuristic:\n                // 1. Check if full path maps to a directory -> It's a list (resource=full path).\n                // 2. Else, split last segment as ID, rest as resource.\n\n                const folderNs = ns === 'ldlms' ? 'ld' : ns;\n                const rootMockDir = path.resolve(process.cwd(), `mocks/wordpress/${folderNs}`);\n                const possibleDir = path.join(rootMockDir, pathSuffix);\n\n                let resource, id;\n\n                if (fs.existsSync(possibleDir) && fs.lstatSync(possibleDir).isDirectory()) {\n                    // It is a directory (e.g. products/categories, or products)\n                    resource = pathSuffix;\n                    id = null;\n                } else {\n                    // It is not a directory. Assume last part is ID.\n                    const parts = pathSuffix.split('/');\n                    if (parts.length > 1) {\n                        id = parts.pop();\n                        resource = parts.join('/');\n                    } else {\n                        // Should have been a directory if it was a list root... \n                        // But maybe directory is missing?\n                        resource = pathSuffix;\n                        id = null;\n                    }\n                }\n\n                const baseDir = path.join(rootMockDir, resource);\n\n                if (id) {\n                    // Try specific ID\n                    const specific = path.join(baseDir, `${id}.json`);\n                    const def = path.join(baseDir, 'default.json');\n\n                    if (fs.existsSync(specific)) {\n                        mockFile = specific;\n                    } else if (fs.existsSync(def)) {\n                        mockFile = def;\n                    } else {\n                        // Fallback: Check if list exists, maybe? No, usually ID call expects object.\n                        // If really nothing found, we let fall through to 404\n                    }\n                } else {\n                    // List\n                    const list = path.join(baseDir, 'list.json');\n                    if (fs.existsSync(list)) {\n                        mockFile = list;\n                    }\n                    // Some endpoints like singletons (users-course-progress) might behave like \"default\" without ID?\n                    // Check if there is a 'default.json' for the resource root? \n                    // e.g. users-course-progress_v2/default.json\n                    const rootDefault = path.join(baseDir, 'default.json');\n                    if (!mockFile && fs.existsSync(rootDefault)) {\n                        mockFile = rootDefault;\n                    }\n                }\n            } else {\n                console.log(`[MOCK] URL ${url} did not match supported patterns.`);\n            }\n\n            if (mockFile && fs.existsSync(mockFile)) {\n                try {\n                    const data = JSON.parse(fs.readFileSync(mockFile, 'utf8'));\n                    console.log(`[MOCK] Serving ${mockFile} for ${url}`);\n                    resolve({\n                        data,\n                        status: 200,\n                        statusText: 'OK',\n                        headers: {},\n                        config,\n                        request: {}\n                    });\n                } catch (e) {\n                    reject({ message: 'Failed to parse mock file', config, response: { status: 500 } });\n                }\n            } else {\n                console.log(`[MOCK] No mock found for ${url}, returning 404`);\n                // Simulate 404 for unknown mocks\n                reject({\n                    message: 'Request failed with status code 404',\n                    name: 'AxiosError',\n                    code: 'ERR_BAD_REQUEST',\n                    config,\n                    response: {\n                        status: 404,\n                        statusText: 'Not Found',\n                        data: { code: 'rest_no_route', message: 'No route was found matching the URL and request method', data: { status: 404 } }\n                    }\n                });\n            }\n        });\n    };\n}\n\n// Helper for Basic Auth (WooCommerce)\nconst getWcAuthHeader = () => {\n    const auth = Buffer.from(`${config.wordpress.wcConsumerKey}:${config.wordpress.wcConsumerSecret}`).toString('base64');\n    return `Basic ${auth}`;\n};\n\n// Helper for Application Password (LearnDash)\nconst getLdAuthHeader = () => {\n    const auth = Buffer.from(`${config.wordpress.ldUser}:${config.wordpress.ldAppPassword}`).toString('base64');\n    return `Basic ${auth}`;\n};\n\nmodule.exports = {\n    wpClient,\n    getWcAuthHeader,\n    getLdAuthHeader\n};\n"],"mappings":"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","ignoreList":[]}